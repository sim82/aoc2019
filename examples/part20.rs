use aoc2019::monitoring::*;
use pathfinding::prelude::dijkstra;
use std::collections::HashMap;
use std::str::FromStr;

struct CharMap2d {
    data: Vec<Vec<char>>,
}

impl CharMap2d {
    fn new(data: &Vec<&'static str>) -> Self {
        let data = data.iter().map(|line| line.chars().collect()).collect();
        CharMap2d { data }
    }

    fn get_point(&self, p: &Point) -> char {
        let x = p.x as usize;
        let y = p.y as usize;
        if y >= self.data.len() || x >= self.data[y].len() {
            panic!("out of bounds: {} {}", x, y);
        }
        self.data[y][x]
    }

    fn get_neighbors<'a, P: 'a>(
        &'a self,
        p: &'a Point,
        mut predicate: P,
    ) -> impl Iterator<Item = (Dir, char)> + 'a
    //Vec<(Dir, char)>
    where
        P: FnMut(&char) -> bool,
    {
        const DIRS: [Dir; 4] = [Dir::Up, Dir::Right, Dir::Down, Dir::Left];
        DIRS.iter().filter_map(move |dir| {
            let neighbor = p.move_into(dir);
            let nc = self.get_point(&neighbor);
            if predicate(&nc) {
                Some((dir.clone(), nc))
            } else {
                None
            }
        })
        // .collect()
    }

    fn get_x_range(&self, y: i32) -> std::ops::Range<i32> {
        0..self.data[y as usize].len() as i32
    }
    fn get_y_range(&self) -> std::ops::Range<i32> {
        0..self.data.len() as i32
    }
}

struct Node {
    name: String,
    nearest: Point,
}

fn find_nodes(cm: &CharMap2d) -> Vec<Node> {
    let mut nodes = Vec::new();
    for y in cm.get_y_range() {
        for x in cm.get_x_range(y) {
            let p = Point::new(x, y);
            if cm.get_point(&p) == '.' {
                let neighbors: Vec<(Dir, char)> =
                    cm.get_neighbors(&p, |n| n.is_uppercase()).collect();
                if neighbors.is_empty() {
                    continue;
                }
                let (dir, c1) = &neighbors[0];
                let c2 = cm.get_point(&p.move_into(dir).move_into(dir));
                let name = match dir {
                    Dir::Up | Dir::Left => format!("{}{}", c2, c1),
                    Dir::Down | Dir::Right => format!("{}{}", c1, c2),
                };
                println!("node: {} {:?}", name, p);
                nodes.push(Node { name, nearest: p })
            }
        }
    }

    nodes
}
fn build_node_graph(cm: &CharMap2d, nodes: &Vec<Node>) -> Vec<(String, String, usize)> {
    let point_to_node: HashMap<Point, String> = nodes
        .iter()
        .map(|node| (node.nearest, node.name.clone()))
        .collect();

    let mut adj = Vec::<(String, String, usize)>::new();

    for n1 in nodes {
        for n2 in nodes {
            if n1.name == n2.name {
                continue;
            }
            if let Some(path) = dijkstra(
                &n1.nearest,
                |s| {
                    cm.get_neighbors(s, |n| *n == '.')
                        .map(|(ref dir, c)| (s.move_into(dir), 1))
                        .collect::<Vec<_>>()
                },
                |s| *s == n2.nearest,
            ) {
                println!("path: {} -> {}: {}", n1.name, n2.name, path.1 + 1);
                adj.push((n1.name.clone(), n2.name.clone(), path.1 + 1));
            }
        }
    }
    adj
}

fn main() {
    let cm = CharMap2d::new(&data20());
    let nodes = find_nodes(&cm);
    let adj = build_node_graph(&cm, &nodes);

    let start = String::from_str(&"AA").unwrap();
    let res = dijkstra(
        &start,
        |s| {
            // adj.iter()
            //     .filter_map(|a| {
            //         if a.0 == *s {
            //             Some((a.1.clone() as String, a.2 as usize))
            //         } else {
            //             None
            //         }
            //     })
            //     .collect()
            let mut succ = Vec::new();
            for (n1, n2, d) in &adj {
                if n1 == s {
                    succ.push((n2.clone(), *d));
                }
            }

            succ
        },
        |s| s == "ZZ",
    );

    println!("res: {:?}", res);
}

fn data20() -> Vec<&'static str> {
    if false {
        vec![
            "                   A               ",
            "                   A               ",
            "  #################.#############  ",
            "  #.#...#...................#.#.#  ",
            "  #.#.#.###.###.###.#########.#.#  ",
            "  #.#.#.......#...#.....#.#.#...#  ",
            "  #.#########.###.#####.#.#.###.#  ",
            "  #.............#.#.....#.......#  ",
            "  ###.###########.###.#####.#.#.#  ",
            "  #.....#        A   C    #.#.#.#  ",
            "  #######        S   P    #####.#  ",
            "  #.#...#                 #......VT",
            "  #.#.#.#                 #.#####  ",
            "  #...#.#               YN....#.#  ",
            "  #.###.#                 #####.#  ",
            "DI....#.#                 #.....#  ",
            "  #####.#                 #.###.#  ",
            "ZZ......#               QG....#..AS",
            "  ###.###                 #######  ",
            "JO..#.#.#                 #.....#  ",
            "  #.#.#.#                 ###.#.#  ",
            "  #...#..DI             BU....#..LF",
            "  #####.#                 #.#####  ",
            "YN......#               VT..#....QG",
            "  #.###.#                 #.###.#  ",
            "  #.#...#                 #.....#  ",
            "  ###.###    J L     J    #.#.###  ",
            "  #.....#    O F     P    #.#...#  ",
            "  #.###.#####.#.#####.#####.###.#  ",
            "  #...#.#.#...#.....#.....#.#...#  ",
            "  #.#####.###.###.#.#.#########.#  ",
            "  #...#.#.....#...#.#.#.#.....#.#  ",
            "  #.###.#####.###.###.#.#.#######  ",
            "  #.#.........#...#.............#  ",
            "  #########.###.###.#############  ",
            "           B   J   C               ",
            "           U   P   P               ",
        ]
    } else {
        vec![
"                                       T   L           B   P       C       B Z           M                                     ",
"                                       I   P           A   P       U       N Z           S                                     ",
"  #####################################.###.###########.###.#######.#######.#.###########.###################################  ",
"  #.......#.....#...#.....#.#.#.....#.#.#.........#.......#.....#.....#.#.....#.#...#.#.....#...#.....#.#.....#.#.#...#.....#  ",
"  ###.#######.#.###.#.#.###.#.#.#####.#.#########.#.#.#.#####.#####.###.###.###.#.###.#.#####.###.#####.###.###.#.#.###.#.###  ",
"  #.#.#.#...#.#...#...#...#.#.#.#.........#...#...#.#.#.....#.#.#.........#.........#.#.......#.....#...#...#.#.......#.#...#  ",
"  #.#.#.#.#######.#######.#.#.#.#######.###.###.###.###.#.###.#.#.###.#########.#.###.###.###.#.#####.###.###.#.#########.###  ",
"  #.......#.#...#...#.......#.......#.....#...#...#.#.#.#.#.....#.#.....#.#.#...#...#...#...#.........#...#.......#.#...#...#  ",
"  #####.###.###.#.#########.#.#.#######.###.#.#.#.#.#.#####.#.#.###.#####.#.#.#######.#.#.#####.###.#####.#.###.#.#.###.#.#.#  ",
"  #...#...#.#...........#.#.#.#...#.#.....#.#.#.#.#.......#.#.#...#.........#...#.#...#.....#.....#.#.#.......#.#.#.#.....#.#  ",
"  #.#.#.###.###.###.###.#.#.###.###.#####.#.#.###.#.#############.#######.#####.#.#.#######.#####.###.#.#.###.#####.###.#.###  ",
"  #.#...#.#.#...#...#.....................#.#...#.#.#.#...........#...........#...#.......#.#...#.#.#...#.#.....#.#.#...#...#  ",
"  ###.#.#.#.###.###.#######.#.#.#######.###.###.#.#.#.#####.#.#.###.###.#.#######.#.###.#.#####.###.#.#######.###.#.###.###.#  ",
"  #.#.#.#...#.#.#.#.#.#.#.#.#.#.....#...#.....#...#...#.#...#.#.#.#.#.#.#...#.#...#...#.#...#.#.#.....#.#...#...#.#.#.#...#.#  ",
"  #.#.###.###.###.###.#.#.#.###.#######.###.#.#####.###.###.#.###.#.#.###.###.###.#.#####.###.#.#.#####.#.#######.#.#.#.#####  ",
"  #...#...#...#...#...#.......#.#.#...#...#.#.....#.#.#.....#.#.#.......#...#.....#.....#.............#.....#...#...#.#...#.#  ",
"  ###.###.###.###.###.#.###.#####.###.#.#######.#.#.#.#####.###.###.#####.###.###.#.#####.#####.#######.#######.#.###.###.#.#  ",
"  #...#.....#...#.......#...#.#.#...#.........#.#.#.#...#.......#...#.#.....#...#.#.#.......#.....#...#.........#...#...#...#  ",
"  ###.###.###.#####.###.#.#.#.#.#.###.#.#.#######.#.#.#####.#.#####.#.#######.###.#####.#.###.###.#.###.#########.###.#####.#  ",
"  #.#.#.#...#...#.#...#.#.#.#.....#.#.#.#.#...#.#.#.......#.#.#...........#...#.....#...#.#.....#.........#.....#.#.........#  ",
"  #.#.#.###.#.###.###############.#.###.#####.#.#.#.###.#####.#######.###########.#.#####.#######.#.###.#.###.###.###.#######  ",
"  #.#.#.#.......#...#.....#.#...#.......#.........#.#.#.#.....#...#...#.......#...#.#.#.........#.#.#...#.#.#.#.#.#.........#  ",
"  #.#.#.###.#.#####.###.###.###.#.#####.###.#######.#.###.#.#####.#.#####.#######.###.#.###########.#.#.###.#.#.#.###.#######  ",
"  #.........#.#.......#.#.#.......#.......#.....#.#.....#.#.#.#...........#.........#.............#.#.#.#.#.......#.....#.#.#  ",
"  #####.###.#######.###.#.#######.#.#.#.###.###.#.###.#####.#.#.#####.#.#########.#######.#.#####.#######.###.###.#.#####.#.#  ",
"  #...#.#.....#.#.....#.#...#...#.#.#.#...#.#.#...#.......#.#.#.#.....#.#.#...#...#.....#.#.....#...#.....#.#.#...#.....#.#.#  ",
"  ###.#.#######.###.#.#.#.###.###########.###.###.#.#.#####.#.###.#.#####.###.###.#.#.###.#############.###.#####.#####.#.#.#  ",
"  #...#...#.#...#...#.#.....#...........#.#.#.....#.#...#.....#...#.....#.........#.#...#.#.#.....#.#.....#.....#.........#.#  ",
"  ###.#.###.###.#.#####.#####.###.#####.#.#.#####.#.#######.#########.#######.#.###.###.#.#.#.#####.#####.###.###.#####.###.#  ",
"  #...#...#.#...#...#.#...#...#.....#...#...#...#.#.#.....#...#.#.#.........#.#.#...#.#.............#...........#.....#.#...#  ",
"  ###.#.###.###.#.###.#.###############.#.###.###.#.#.###.#.###.#.#.###.#######.###.#.###.#.#.#############.#####.###.###.###  ",
"  #...#.....#.....#.....#...#.#.......#...#.#...#.#...#.#.#.#...#.....#.#...#.....#.....#.#.#.#.#.#.#.#.....#.......#.#.....#  ",
"  #.#####.###.#.#######.#.###.#######.###.#.#.#.#.#.###.#.#.###.#####.#####.###.#.###.###.#####.#.#.#.###.#.#####.#######.#.#  ",
"  #.....#...#.#...#.#.#...#...#.....#.....#...#...#.#.....#.....#.....#.........#.#.....#...#.....#...#...#.#.#...#.#.....#.#  ",
"  ###.#.#.###.#####.#.#.#.#.#####.#####.#####.#######.#########.###.#########.#########.#####.#.#####.#####.#.###.#.#####.###  ",
"  #.#.#...#.#...#.#...#.#.#.#.#...#    F     I       C         B   B         J         K    #.#.#...#.....#...#...#...#.....#  ",
"  #.#####.#.#.###.###.###.#.#.###.#    X     O       U         A   N         J         N    ###.#.#####.###.#####.###.###.###  ",
"  #.........................#.....#                                                         #.....#.........#.......#.....#.#  ",
"  #.#.#.#####.#############.#.###.#                                                         ###.#.#.###.###.#.#####.#.#.###.#  ",
"  #.#.#.....#.#.#...#...#...#...#.#                                                         #...#.....#.#.....#.....#.#.#....QD",
"  #.#.#.#######.###.#.#.#.###.#.#.#                                                         ###.#####.#######.#####.#.#.###.#  ",
"MX..#.#...#.#.....#...#...#...#.#..PP                                                     TI..#.....#.#...#...#.#.....#...#.#  ",
"  #####.###.###.###.#.#########.#.#                                                         #.###.###.#.#.#####.#########.#.#  ",
"  #...#...#...#.#.#.#...........#.#                                                         #.....#.#.#.#.#...#...#.#...#...#  ",
"  #.#######.###.#.#################                                                         #######.###.#####.#.###.#.#######  ",
"  #.......#...................#.#.#                                                       QD..........#...................#..HM",
"  #.#.###.#.#.#.#######.#.###.#.#.#                                                         #.###.###.#.#.#.###########.###.#  ",
"  #.#...#...#.#.#...#...#...#.....#                                                         #...#...#...#.#.#...#.....#...#.#  ",
"  #####.#.#.###.#.#.#######.###.#.#                                                         #.###.#####.#######.#.#.###.###.#  ",
"  #.....#.#...#...#.#.#...#.#...#.#                                                       LP..#...#...#.#.........#.....#....OL",
"  #.#.###.###########.#.#######.###                                                         #########.#####.###.#########.#.#  ",
"HG..#.#...#.#...#.#...#...#...#....DY                                                       #...#.........#.#.............#.#  ",
"  #.#######.###.#.#.###.###.#######                                                         #.#####.#.#.#####################  ",
"  #.#.....................#...#...#                                                         #.....#.#.#.....#...#.....#......FG",
"  ###.#######.#.#.#.#.#.#.#.#.#.#.#                                                         #####.###.#########.#.#.###.#.###  ",
"  #...#.....#.#.#.#.#.#.#...#...#.#                                                         #.....#.#...#.#.#.#...#...#.#...#  ",
"  ###.###.#.#####.###.#####.#####.#                                                         #####.#.#.###.#.#.#.#####.#.#.###  ",
"  #.......#...#.....#...#.....#.#.#                                                       QQ....................#.#.#...#...#  ",
"  #########.#.#.#.###.###.#.#.#.#.#                                                         #####.###############.#.#.#####.#  ",
"AJ..........#.#.#...#.#...#.#.#....OL                                                     WP..#...#.................#.#.#.#.#  ",
"  ###############.#########.###.#.#                                                         #.#######.###.#.###.###.###.#.###  ",
"LQ..#.........#.........#.#.#.#.#.#                                                         #.....#.....#.#...#...#.....#....FN",
"  #.#.#.#################.###.#####                                                         #.#.#####.#.###.###########.###.#  ",
"  #...#.....#.......#.#.#.#.#.....#                                                         #.#.#.....#.#...#...#.#.#...#...#  ",
"  #.#.#.#.#.###.#.###.#.#.#.#####.#                                                         ###.#.#####.###.###.#.#.#.###.#.#  ",
"  #.#.#.#.#.#.#.#...#.#.....#.#.#..HM                                                       #.#...#.#.#.#.#.#...#.#.#.....#.#  ",
"  ###.#.###.#.#.#####.#####.#.#.#.#                                                         #.#####.#.###.#####.#.#.#########  ",
"  #.#.#.#.#.......................#                                                       AJ..#.......................#.....#  ",
"  #.#####.#######################.#                                                         #.#.###.#.#.###.###.#####.#.###.#  ",
"QQ......................#.......#.#                                                         #.....#.#.#.#.....#.#.......#...#  ",
"  #.#####.###.#####.#.###.#####.###                                                         #.#####.#.#######.#######.###.###  ",
"  #.#.#.#.#.....#...#...#.#.....#..IC                                                       #.#...#.#.....#...#.....#.#.#.#.#  ",
"  #.#.#.#.#.#########.###.#.#####.#                                                         ###.#############.#.#.#####.#.#.#  ",
"  #.#.#.#.#.#.............#.....#.#                                                         #...#.#.....#...#.#.#.......#....DY",
"  ###.#.###########.###########.#.#                                                         #.###.#.#####.#########.#########  ",
"  #.#.....#.#.#.#.#.#.#...#...#...#                                                       MX....#.......#.................#..IO",
"  #.###.###.#.#.#.###.###.###.###.#                                                         ###.#.#####.#.###.#.###.#.#.#.#.#  ",
"RW..#.....#...................#...#                                                         #...#...#.#...#...#.#...#.#.#.#.#  ",
"  #.#.#.#.###.###.#####.#.#.#######                                                         #.###.###.#.###.#####.#.#####.#.#  ",
"  #.#.#.#.....#.......#.#.#...#....LQ                                                       #...#.#.#.....#.....#.#.#.......#  ",
"  #.#.#####.#.#####.#####.#.#.###.#                                                         ###.#.#.#######.###########.###.#  ",
"  #.......#.#.#.#.......#.#.#.#...#                                                         #...........#...#.......#...#...#  ",
"  #.#.#######.#.###.#.###.###.###.#                                                         ###.#.#####.###.#.#######.#####.#  ",
"  #.#.....#...#.#...#.#...#.......#                                                         #...#.....#.#.....#...#...#.....#  ",
"  ###.#####.#.#.###.#####.###.###.#    F         H       U       I     R     F         M    #.#######.#.###.#.#.###########.#  ",
"  #...#...#.#.#.........#.#.....#.#    G         G       S       F     W     N         S    #.....#.#.#.#.#.#.......#.......#  ",
"  ###.#.#####.###.###.###.#.#####.#####.#########.#######.#######.#####.#####.#########.#######.###.###.#.#.#####.#.#######.#  ",
"  #.........#...#.#...#.#.#.#.#...#.......#.......#.#.#.....#.....#.........#.#.............#...#.......#...#.#...#.#.......#  ",
"  #.###.#############.#.###.#.#.#.###.###.#####.###.#.#.#####.###########.###.###.###############.#.#####.#.#.###.#####.###.#  ",
"  #.#...#.......#.........#.#...#...#...#...#.....#.....#.#.......#...#.#...#.#.#.#...........#.#.#.#.....#...#.#.#.#...#...#  ",
"  #.###.#.#####.#.#.###.#######.#####.#####.#.#.#####.#.#.###.###.###.#.#.###.#.#.#.###.#.###.#.###.###.#.###.#.###.###.###.#  ",
"  #.#.#.#.#.#.....#.#.....#.#.#...#.....#.#.#.#...#...#.#...#.#.....#.......#...#.#...#.#.#.....#.#...#.#.#.........#.....#.#  ",
"  ###.#####.###.#.#####.###.#.###.###.#.#.#####.#####.###.#########.#.#.###.#.#.#.#.###.#.###.###.#.#########.#.#.#########.#  ",
"  #.#...........#.#.......#...#...#...#.#.....#.#.#...#.#...#.......#.#...#.#.#.#...#...#...#...#.....#...#...#.#.#.#.#.#...#  ",
"  #.#.###.#.#.#.###########.#########.#######.#.#.#.#.###.#.#.###########.#####.#####.#.#.#.#############.#.#.###.#.#.#.###.#  ",
"  #...#...#.#.#.#...#...#.....#...#.....#.........#.#.#...#.#.....#.#.....#.#.......#.#.#.#.#.#.#...#.....#.#.#.......#.....#  ",
"  #.###.#####.#.###.###.###.#####.###.#####.#.###.###.#.###.#.#####.#.#.###.###.#.#####.#####.#.#.###.#####.#.###.#.###.###.#  ",
"  #.#...#.....#...#...................#...#.#...#...#.....#.#.......#.#.....#...#.#.#.#...#.#.#.........#.#.#.#...#.#...#.#.#  ",
"  #####.#####.#####.#.###.#.#.#.#.###.#.#####.#############.#.#.###.#####.#####.###.#.#.#.#.#.###.###.#.#.###.###.#####.#.###  ",
"  #.....#...#.#.....#...#.#.#.#.#...#.....#...#.#.#.........#.#.#...#.#...#.#.....#.#...#...#.#...#.#.#.#...#.#.#.....#.....#  ",
"  #.###.###.#######.#.#######.###.###.#######.#.#.###.###.#######.###.#.###.###.###.###.#####.#.###.#####.###.#.###.###.###.#  ",
"  #.#...#...#.#.....#.#.#.....#.#.#...#.#...#...#.....#.........#.....#...#.#.#.......#...........#.......#.......#...#.#...#  ",
"  #.#.#####.#.#####.###.#.###.#.#.###.#.#.###.#.#####.###.#########.###.###.#.#.#.#####.###.#########.#.#.#.###.#######.#.###  ",
"  #.#.#...............#...#.#...#.#.........#.#.....#.#.#.#.#.#.#...#.....#.#...#...#.....#...........#.#.#.#.........#.#.#.#  ",
"  #.###.#.###.#.#.#.###.#.#.###.#####.###.#.#.#######.#.###.#.#.#.#######.#.#.###.#####.#####.###.###.#.#.#####.#######.###.#  ",
"  #...#.#.#...#.#.#.#...#.#.#.#.#.....#...#.#.....#.....#.....#.......#...#...#.#.#.........#...#...#.#.#...#.........#.#.#.#  ",
"  #.#########.###.#.#######.#.#######.#####.###.#####.#.###.#.#####.#.###.#.###.#.###.###.###.###.#####.#########.###.###.#.#  ",
"  #.....#.......#.#.#.....#.#.#.#.#.#.#...#...#...#...#.#...#.#.#...#...#.#...#.#.#.#...#...#.#.....#...........#...#.......#  ",
"  #.#.#######.#####.#####.#.#.#.#.#.###.#.#.###.#####.#####.###.#.#######.###.#.###.#.#.#############.#.###.#.#.#######.#####  ",
"  #.#...#...#.#.....#.........#.........#.#...#...#.......#...#.....#.#...#.....#.#...#...........#.#.#...#.#.#.......#.....#  ",
"  #.#####.#####.#.#########.###.#.###.###.#.###.#.###.###.#.#######.#.#.###.#####.###.#.#.#.#.#.#.#.###.###.###.###.#########  ",
"  #.#...#.#.#...#.#.....#.....#.#...#.#.#.....#.#...#.#.#...#.#...#...#...#.....#.#...#.#.#.#.#.#.....#...#...#.#.....#...#.#  ",
"  #.###.#.#.###.###.#####.###.###.###.#.#########.#####.###.#.#.#.#.###.#.###.###.###.#.#####.###.#.###.###.###.#####.#.###.#  ",
"  #.#...........#.....#.#.#.#...#.#...#.....#.....#.#.#...#...#.#.....#.#.#.........#.#...#...#.#.#.#...#.....#...#.........#  ",
"  #.###.#########.#.#.#.###.#.#######.###.#.###.###.#.###.#.#####.#.#####.#####.#######.#######.#######.###.#.#.#.#.#.###.#.#  ",
"  #.#.....#.......#.#.................#...#...#.....#.......#.....#...#.....#.#.#.#.#...#.........#.......#.#.#.#.#.#.#...#.#  ",
"  #.#######.#.###.#.#.###.#.#.#.###.#.#.###.#######.#.#############.###.#####.#.#.#.###.#.#####.#.###.###.#####.#.###.#####.#  ",
"  #.#.......#.#...#.#.#...#.#.#.#...#...#...#.......#.........#.....#.........#.#.............#.#.#.....#...#...#...#...#...#  ",
"  #########################################.#.###########.#######.###.###.#####.###.#########################################  ",
"                                           I I           J       W   K   A     U   F                                           ",
"                                           F C           J       P   N   A     S   X                                           ",


        ]
    }
}
